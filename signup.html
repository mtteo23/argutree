<!DOCTYPE html>
<html lang="en">
	<head>
		<link rel="stylesheet" href="/src/css/style-general.css">
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Sign up</title>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="/src/js/banner.js" defer></script>
	</head>
	<body>
		<div id="banner"></div>
    
		<div class="signup-container">
			<h2>Sign up</h2>
			<input type="username" id="username" placeholder="Username" required>
			<input type="text" id="email" placeholder="Email" required>
			<input type="password" id="password" placeholder="Password" required>
			<button onclick="signup()">Sign up</button>
			<div id="error" class="error"></div>
		</div>
	</body>
	<script>
    //const supabaseUrl = 'https://htbxgsolhsxacotnprjq.supabase.co';
    //const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Ynhnc29saHN4YWNvdG5wcmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE2MzQ2MzAsImV4cCI6MjA1NzIxMDYzMH0.OJy9IdF8aWh_YuqU3WIdvuqAX-2GAfTTjMxu9zMAHMo';
    //const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
      
    async function signup() {
      const email    = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value;
      const errorDiv = document.getElementById('error');
      errorDiv.textContent = '';

      if (!await controlUsername(username)) return;

      try {
        const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email, password });
        if (authError) {
          if (/duplicate|already registered/i.test(authError.message)) {
            errorDiv.textContent = 'That email is already registered.';
            return;                     // ‚Üê must return here
          }
          throw authError;
        }

        // insert profile (either via table or RPC)
        const { error: insertError } = await supabaseClient
          .from('User')
          .insert([{ user_id: authData.user.id, username }]);
        if (insertError) console.error('Profile insert failed', insertError);

      } catch (err) {
        console.error(err);
        errorDiv.textContent = err.message || 'Something went wrong.';
      }
    }
    
    async function controlUsername(username) {
      const errorDiv = document.getElementById('error');
      
      const { data: isAvailable, error } = await supabaseClient
      .rpc('check_username_available', { _username: username });
      
      if (!isAvailable) {
        errorDiv.textContent = 'That username is already taken.';
        return false;
      }
      return true;
    }
  </script>
</html>
