<!DOCTYPE html>
<html lang="en">
	<head>
		<link rel="stylesheet" href="/src/css/style-general.css">
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Sign up</title>
		<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
	</head>
	<body>
		<div id="banner">
			<a href="index.html" align="center">Main Page</a>
			<a href="explore.html">Explore</a>
			<a href="login.html">Log in</a>
			<a id="signup" href="signup.html">Sign up</a>
		</div>
		<div class="signup-container">
			<h2>Sign up</h2>
			<input type="username" id="username" placeholder="Username" required>
			<input type="text" id="email" placeholder="Email" required>
			<input type="password" id="password" placeholder="Password" required>
			<button onclick="signup()">Sign up</button>
			<div id="error" class="error"></div>
		</div>
	</body>
	<script>
    const supabaseUrl = 'https://htbxgsolhsxacotnprjq.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh0Ynhnc29saHN4YWNvdG5wcmpxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE2MzQ2MzAsImV4cCI6MjA1NzIxMDYzMH0.OJy9IdF8aWh_YuqU3WIdvuqAX-2GAfTTjMxu9zMAHMo';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    
    async function signup() {
      const email    = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const username = document.getElementById('username').value;
      const errorDiv = document.getElementById('error');
      let   problem  = false;

      // Clear previous error messages
      errorDiv.textContent = '';

      if (!await controlUsername(username)) problem = true;
      // we no longer need to await controlEmail – it'll always pass:
      // if (!await controlEmail(email)) problem = true;

      if (!problem) {
        try {
          // Sign up the user
          const { data: authData, error: authError } = await supabaseClient.auth.signUp(
            { email, password },
            { // disable the built-in redirect so we stay in this flow
              redirectTo: window.location.origin  
            }
          );
          if (authError) {
            // Look specifically for the "duplicate email" case:
            if (authError.message.toLowerCase().includes('already registered') ||
                authError.message.toLowerCase().includes('duplicate')) {
              errorDiv.textContent = 'That email is already registered.';
              return;    // bail out early
            }
            // for any other auth error, show its message
            throw authError;
          }

          if (!authData?.user?.id) {
            throw new Error('User ID is missing after sign-up.');
          }

          // Insert the profile row with username & user_id
          const { data, error } = await supabaseClient
            .from('User')
            .insert([{ user_id: authData.user.id, username }]);
          if (error) {
            console.error('Error inserting display name:', error);
            // you could surface this to the user if you like
          }

          // Everything succeeded → log them in
          login(email, password);

        } catch (err) {
          // Fallback for any unexpected errors
          console.error(err);
          errorDiv.textContent = err.message || 'Something went wrong.';
        }
      }
    }

    async function controlUsername(username) {
      const errorDiv = document.getElementById('error');

      if (!username) {
        errorDiv.textContent = 'Username cannot be empty.';
        return false;
      }

      const { data, error } = await supabaseClient
        .from('User')
        .select('user_id', { count: 'exact' })
        .eq('username', username)
        .limit(1);

      if (error) {
        console.error('Error checking username:', error);
        errorDiv.textContent = 'Unable to verify username uniqueness.';
        return false;
      }

      if (data.length > 0) {
        errorDiv.textContent = 'That username is already taken.';
        return false;
      }

    return true;
  }

  async function login(email, password){
    try {
      const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

      if (error)
        throw error;
        
      // Redirect or show success message
      window.location.href = "profile.html";
    } catch (error) {
      errorDiv.textContent = error.message;
		}
  }
  </script>
</html>
